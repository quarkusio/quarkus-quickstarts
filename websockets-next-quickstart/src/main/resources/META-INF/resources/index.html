<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Quarkus Chat</title>
</head>
<body>

<div class="container">
    <h2>Simple WebSocket Chat</h2>
    <form id="" action="">
        <label for="user">User </label><input id="user">
        <input id="connectButton" type="button" onclick="openWebsocket()" value="Connect">
    </form>
    <br>
    <form action="">
        <label for="message">Message </label><input id="message" disabled>
        <input id="sendButton" type="button" onclick="sendMessage()" value="Send" disabled>
    </form>
    <br>
    <div id="chat"></div>
</div>

<script type="text/javascript">
    let websocket = undefined;
    let connected = false;
    let username = "";

    function openWebsocket() {
        if (connected) {
            return;
        }

        const secure = location.protocol === "https:" ? "s" : "";
        websocket = new WebSocket(`ws${secure}://` + location.host + "/chat/" + user.value);

        websocket.onopen = function() {
            console.log("Connected to " + websocket.url);

            $("user").disabled = true;
            $("connectButton").disabled = true;
            $("message").disabled = false;
            $("sendButton").disabled = false;
            $("message").focus()
            connected = true;
            username = user.value
        }

        const chat = $("chat");
        websocket.onmessage = function(event) {
            const chatMessage = JSON.parse(event.data);

            switch (chatMessage.type) {
                case "USER_JOINED":
                    if (chatMessage.from !== username) {
                        chat.innerHTML = `<p><b>${chatMessage.from} joined the chatroom.</b></p>` + chat.innerHTML;
                    } else {
                        chat.innerHTML = `<p><b>System</b>: Howdy ${chatMessage.from}</p>` + chat.innerHTML;
                    }
                    break;
                case "USER_LEFT":
                    chat.innerHTML = `<p><b>${chatMessage.from} left the chatroom.</b></p>` + chat.innerHTML;
                    break;
                case "CHAT_MESSAGE":
                    chat.innerHTML = `<p><b>${chatMessage.from}</b>: ${chatMessage.message} </p>` + chat.innerHTML;
                    break;
            }

            $("message").value = ""
        }

        websocket.onerror = function(event) {
            chat.innerHTML = `Error: ${event.data} <br>` + chat.innerHTML;
        }
    }

    function sendMessage() {
        const chatMessage = {
            type: "CHAT_MESSAGE",
            from: user.value,
            message: message.value
        };
        websocket.send(JSON.stringify(chatMessage));
    }

    // poor man's version of jquery selector
    function $(elementId) {
        return document.getElementById(elementId);
    }

    function mapEnterKeyToFunction(elementId, functionName) {
        const inputElement = $(elementId);
        inputElement.addEventListener("keydown", event => {
            if (event.key === 'Enter') {
                event.preventDefault();
                functionName();
            }
        })
    }

    mapEnterKeyToFunction("user", openWebsocket);
    mapEnterKeyToFunction("message", sendMessage);
</script>

</body>
</html>