<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Quarkus Chat</title>

    <style>
        body {
            font-family: Arial, Helvetica, sans-serif;
        }

        input {
            padding: 0.3em 1em;
            background: WhiteSmoke;
            border: 1px solid lightgray;
            border-radius: 3px;
            box-shadow: rgba(0, 0, 0, 0.05) 0 1px 0 0;
        }

        input[type="text"] {
            min-width: 30em;
        }

        input[type="button"] {
            min-width: 7em;
        }

        #chat {
            border: 1px solid black;
            min-height: 2em;
            padding: 0.3em 0.8em;
        }

        #sendButton {
            background-color: #2B7FFF;
            color: white;
        }

        .label {
            min-width: 5em;
            display: inline-block;
            font-weight: bold;
        }

        .system {
            color: #E12AFB;
        }

        .user {
            color: #51A2FF;
        }

        .info {
            color: gray;
        }
    </style>
</head>

<body>
    <div class="container">
        <h2>Simple WebSocket Chat</h2>
        <form action="">
            <input id="user" type="text" placeholder="your name">
            <input id="connectButton" type="button" onclick="openWebsocket()" value="connect">
        </form>
        <br>
        <div id="chat"></div>
        <br>
        <form action="">
            <input id="message" type="text" placeholder="enter your message" disabled>
            <input id="sendButton" type="button" onclick="sendMessage()" value="send" disabled>
        </form>
        <br>
    </div>

    <script type="text/javascript">
        let websocket = undefined;
        let connected = false;
        let username = "";

        function openWebsocket() {
            if (connected) {
                return;
            }

            const secure = location.protocol === "https:" ? "s" : "";
            websocket = new WebSocket(`ws${secure}://` + location.host + "/chat/" + user.value);

            websocket.onopen = function() {
                console.log("Connected to " + websocket.url);

                $("user").disabled = true;
                $("connectButton").disabled = true;
                $("message").disabled = false;
                $("sendButton").disabled = false;
                $("message").focus()
                connected = true;
                username = user.value
            }

            const chat = $("chat");
            websocket.onmessage = function(event) {
                const msg = JSON.parse(event.data);

                switch (msg.type) {
                    case "USER_JOINED":
                        if (msg.from !== username) {
                            appendLine(chat, null, `${msg.from} joined the chatroom.`, "info")
                        } else {
                            appendLine(chat, "System", `Howdy ${msg.from}!`, "system")
                        }
                        break;
                    case "USER_LEFT":
                        appendLine(chat, null, `${msg.from} left the chatroom.`, "info")
                        break;
                    case "CHAT_MESSAGE":
                        appendLine(chat, msg.from, msg.message, "user")
                        break;
                }

                $("message").value = ""
            }

            websocket.onerror = function(event) {
                chat.innerHTML = `<p>Error: ${event.data}<p>` + chat.innerHTML;
            }
        }

        // probably you want to escape user input on the backend
        function appendLine(chat, username, text, clazz) {
            const span = document.createElement("span");
            if (username) {
                span.classList.add("label", clazz);
                span.innerText = username + ":";
            }

            const p = document.createElement("p");
            p.append(span)
            span.after(text);

            chat.append(p);
        }

        function sendMessage() {
            const chatMessage = {
                type: "CHAT_MESSAGE",
                from: user.value,
                message: message.value
            };
            websocket.send(JSON.stringify(chatMessage));
        }

        // poor man's version of jquery selector
        function $(elementId) {
            return document.getElementById(elementId);
        }

        function mapEnterKeyToFunction(elementId, functionName) {
            const inputElement = $(elementId);
            inputElement.addEventListener("keydown", event => {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    functionName();
                }
            })
        }

        mapEnterKeyToFunction("user", openWebsocket);
        mapEnterKeyToFunction("message", sendMessage);
    </script>
</body>

</html>